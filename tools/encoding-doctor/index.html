<!doctype html>
<html lang="en" data-theme="dark">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-adsense-account" content="ca-pub-3079281180008443">
  <title>Encoding Doctor ‚Äî Fix mojibake &amp; encoding errors ‚Äî TinyUtils</title>
  <script async src="https://fundingchoicesmessages.google.com/i/pub-3079281180008443?ers=1"></script>
  <meta name="description" content="Encoding Doctor repairs mojibake and encoding errors like Fran√É¬ßois d√¢‚Ç¨‚Ñ¢Arcy √¢‚Ç¨‚Äù r√©sum√©. Paste text or upload files to fix √É¬© ‚Üí √©, smart quotes, dashes, and Unicode normalization.">
  <link rel="canonical" href="/tools/encoding-doctor/">
  <link rel="icon" href="/public/icons/tinyutils-icon-dark-32.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" href="/public/icons/tinyutils-icon-light-32.png" media="(prefers-color-scheme: light)">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/icons/tinyutils-icon-light-180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/tinyutils-icon-dark-32.png">
  <meta property="og:title" content="Encoding Doctor ‚Äî Fix mojibake &amp; encoding errors ‚Äî TinyUtils">
  <meta property="og:description" content="Fix mojibake, broken accents, and smart punctuation glitches. Paste text or upload documents and download clean, normalized text.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/public/og.png">
  <meta name="twitter:card" content="summary_large_image">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3079281180008443" crossorigin="anonymous"></script>
  <script src="/scripts/storage-utils.js"></script>
  <script src="/scripts/download-utils.js"></script>
  <script src="/scripts/theme-toggle.js"></script>
  <link rel="stylesheet" href="/public/styles.css">
  <link rel="stylesheet" href="/styles/site.css">
  <script defer src="/scripts/consent.js"></script>
  <script defer src="/scripts/googlefc-consent-adapter.js"></script>
  <script defer src="/scripts/adsense-monitor.js"></script>
  <style>
    main { padding-bottom: 48px; }

    .tool-intro { position: relative; }

    .tool-hero {
      text-align: center;
      padding: var(--space-12, 3rem) 0 var(--space-8, 2rem);
      position: relative;
    }

    .tool-hero-icon {
      font-size: 3.5rem;
      display: block;
      margin-bottom: var(--space-4, 1rem);
    }

    .tool-hero h1 {
      font-size: clamp(1.9rem, 2.4vw + 1rem, 2.4rem);
      margin-bottom: var(--space-2, 0.5rem);
    }

    .tool-hero-subtitle {
      max-width: 52rem;
      margin: 0 auto var(--space-4, 1rem);
      color: var(--muted, #97a3c2);
    }

    .tool-hero .cta {
      font-size: 0.9rem;
      color: var(--muted, #97a3c2);
      text-decoration: none;
    }

    .tool-hero .cta:hover {
      text-decoration: underline;
    }

    .tool-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.1fr);
      gap: var(--space-4, 1rem);
      align-items: flex-start;
      margin-top: var(--space-4, 1rem);
    }

    .card {
      background: var(--surface-base);
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-default);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-top: 0.85rem;
    }

    .field-group label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .field-group textarea {
      min-height: 200px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .field-group input[type="file"] {
      max-width: 100%;
    }

    .options-grid {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.6rem 1rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      align-items: flex-start;
    }

    .options-grid label {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.9rem;
    }

    .options-grid select {
      max-width: 100%;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.85rem;
    }

    .actions-row button {
      border-radius: 0.75rem;
      border: 1px solid transparent;
      padding: 0.55rem 1.25rem;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .actions-row button.primary {
      background: var(--brand, #3b82f6);
      color: var(--text-inverse, #ffffff);
    }

    .actions-row button.primary[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .actions-row button.secondary {
      background: transparent;
      color: var(--muted, #97a3c2);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .status-line {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--muted, #97a3c2);
      min-height: 1.4em;
    }

    .error-box {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(248, 113, 113, 0.12);
      color: #fecaca;
    }

    .error-box.hidden {
      display: none;
    }

    .results-columns {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .results-columns textarea {
      min-height: 190px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .results-summary {
      font-size: 0.85rem;
      color: var(--muted, #97a3c2);
      margin-top: 0.4rem;
    }

    .results-empty {
      font-size: 0.9rem;
      color: var(--muted, #97a3c2);
      margin-top: 0.5rem;
    }

    .file-results {
      margin-top: 0.75rem;
    }

    .file-results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .file-results-table th,
    .file-results-table td {
      padding: 0.4rem 0.35rem;
      text-align: left;
      vertical-align: top;
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
    }

    .file-results-table th {
      font-weight: 600;
      color: var(--muted, #97a3c2);
    }

    .file-summary {
      color: var(--muted, #97a3c2);
    }

    .file-preview {
      white-space: pre-wrap;
      max-height: 6rem;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .download-link {
      font-size: 0.85rem;
      text-decoration: none;
    }

    .download-link button {
      font-size: 0.8rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: var(--muted, #e5e7eb);
      cursor: pointer;
    }

    .download-link button:hover {
      border-color: var(--brand, #3b82f6);
      color: var(--text-inverse, #ffffff);
      background: rgba(59, 130, 246, 0.18);
    }

    .tool-copy {
      margin-top: var(--space-8, 2rem);
      max-width: 52rem;
      font-size: 0.95rem;
    }

    .tool-copy h2 {
      font-size: 1.05rem;
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
    }

    .tool-copy p {
      margin-bottom: 0.6rem;
      color: var(--muted, #97a3c2);
    }

    .tool-copy ul,
    .tool-copy ol {
      margin-left: 1.2rem;
      margin-bottom: 0.6rem;
      color: var(--muted, #97a3c2);
    }

    .tool-copy li {
      margin-bottom: 0.25rem;
    }

    .tool-copy details {
      margin-top: 0.6rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.24);
      padding: 0.55rem 0.75rem;
      background: rgba(15, 23, 42, 0.45);
    }

    .tool-copy summary {
      cursor: pointer;
      font-weight: 500;
      outline: none;
    }

    .tool-copy summary::-webkit-details-marker {
      display: none;
    }

    .tool-copy summary::before {
      content: '‚ñ∏';
      display: inline-block;
      margin-right: 0.4rem;
      transform-origin: center;
      transition: transform 0.15s ease-out;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .tool-copy details[open] summary::before {
      transform: rotate(90deg);
    }

    .tool-copy details p {
      margin-top: 0.45rem;
    }

    @media (max-width: 880px) {
      .tool-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .tool-hero-icon,
      .tool-hero h1,
      .tool-hero-subtitle,
      .card {
        animation: none !important;
      }
    }
  </style>
    <script defer src="/scripts/nav-active.js"></script>
    <script defer src="/scripts/analytics.js"></script>
</head>
  <body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <header class="site-header">
    <div class="container row between center">
      <a class="brand" href="/">TinyUtils</a>
      <div class="row center">
        <nav class="nav">
          <a href="/tools/">Tools</a>
          <a href="/blog/">Blog</a>
          <a href="/about.html">About</a>
          <a href="https://buymeacoffee.com/tinyutils" target="_blank" rel="noopener" class="support-link">‚òï Support</a>
          <span class="nav-item">
            <a href="/privacy.html">Privacy</a>
            <div class="nav-dropdown">
              <a href="/cookies.html">Cookie settings</a>
              <a href="/privacy.html">Privacy policy</a>
              <a href="/terms.html">Terms of service</a>
            </div>
          </span>
        </nav>
        <button class="theme-toggle" type="button" data-theme-toggle aria-pressed="false">Dark</button>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="container tool-intro">
      <div class="tool-hero">
        <span class="tool-hero-icon" aria-hidden="true">üî§</span>
        <h1>Encoding Doctor ‚Äî fix mojibake and encoding errors</h1>
        <p class="tool-hero-subtitle">
          Paste text or upload documents with broken accents like ‚ÄúFran√É¬ßois d√¢‚Ç¨‚Ñ¢Arcy √¢‚Ç¨‚Äù r√©sum√©‚Äù and get back clean, readable text: ‚ÄúFran√ßois d‚ÄôArcy ‚Äî r√©sum√©‚Äù.
        </p>
        <p><a class="cta" href="/tools/">‚Üê Back to all tools</a></p>
      </div>

      <section class="ad-slot" aria-label="Sponsored">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3079281180008443"
             data-ad-slot="3664281983"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          try {
            (adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            console.warn('adsense error', e);
          }
        </script>
      </section>

      <div class="tool-layout" aria-label="Encoding Doctor workspace">
        <section class="card" aria-labelledby="input-heading">
          <h2 id="input-heading">Input &amp; options</h2>
          <p class="help" style="font-size: 0.85rem; color: var(--muted, #97a3c2); margin-bottom: 0.25rem;">
            Paste text, attach files, choose how aggressive you want the fix to be, then run Encoding Doctor.
          </p>

          <div class="field-group">
            <label for="inputText">Paste text with encoding issues (optional)</label>
            <textarea id="inputText" placeholder="Paste text such as: Fran√É¬ßois d√¢‚Ç¨‚Ñ¢Arcy √¢‚Ç¨‚Äù r√©sum√©"></textarea>
          </div>

          <div class="field-group">
            <label for="fileInput">Upload files with mojibake or encoding issues (optional)</label>
            <input id="fileInput" type="file" multiple>
            <p class="help" style="font-size: 0.8rem; color: var(--muted, #97a3c2);">
              Works best with text-friendly formats: TXT, MD, HTML, DOCX, PDF and anything supported by the Document Converter.
            </p>
          </div>

          <div class="field-group">
            <label>Repair settings</label>
            <div class="options-grid">
              <label>
                <input id="optAutoRepair" type="checkbox" checked>
                <span>Auto‚Äërepair mojibake and obvious encoding glitches</span>
              </label>
              <label>
                <input id="optSmartPunctuation" type="checkbox" checked>
                <span>Smart punctuation &amp; whitespace cleanup</span>
              </label>
              <label>
                <span>Unicode normalization</span>
                <select id="optNormalizeForm">
                  <option value="NFC" selected>Normalize to NFC (recommended)</option>
                  <option value="NFKC">Normalize to NFKC</option>
                  <option value="NONE">No Unicode normalization</option>
                </select>
              </label>
            </div>
          </div>

          <div class="actions-row">
            <button id="runButton" class="primary" type="button">Fix encoding</button>
            <button id="resetButton" class="secondary" type="button">Reset</button>
          </div>

          <p id="statusText" class="status-line" aria-live="polite"></p>
          <div id="errorBox" class="error-box hidden" role="alert" aria-live="assertive"></div>
        </section>

        <section class="card" aria-labelledby="output-heading">
          <h2 id="output-heading">Results</h2>

          <div id="resultsEmpty" class="results-empty">
            Run Encoding Doctor to see the original and fixed text here. We‚Äôll also show per‚Äëfile summaries for any uploads.
          </div>

          <div id="textResults" hidden>
            <div class="results-columns" aria-label="Pasted text before and after repair">
              <div>
                <div class="row between center" style="align-items:flex-end; gap:0.5rem;">
                  <label for="outputOriginal" style="font-size: 0.85rem; display: block; margin-bottom: 0.2rem;">Original (preview)</label>
                  <button id="copyOriginal" class="secondary" type="button" style="font-size:0.8rem;">Copy original</button>
                </div>
                <textarea id="outputOriginal" readonly></textarea>
              </div>
              <div>
                <div class="row between center" style="align-items:flex-end; gap:0.5rem;">
                  <label for="outputFixed" style="font-size: 0.85rem; display: block; margin-bottom: 0.2rem;">Fixed text</label>
                  <button id="copyFixed" class="primary" type="button" style="font-size:0.8rem;">Copy fixed</button>
                </div>
                <textarea id="outputFixed" readonly></textarea>
              </div>
            </div>
            <p id="textSummary" class="results-summary" role="status" aria-live="polite"></p>
          </div>

          <div id="fileResults" class="file-results" hidden>
            <h3 style="font-size: 0.95rem; margin-top: 0.25rem;">Files</h3>
            <table class="file-results-table">
              <thead>
                <tr>
                  <th scope="col">File</th>
                  <th scope="col">Summary</th>
                  <th scope="col">Preview (before ‚Üí after)</th>
                  <th scope="col">Download</th>
                </tr>
              </thead>
              <tbody id="fileResultsBody">
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <section class="tool-copy">
        <h2>What is mojibake and why it happens</h2>
        <p>
          Mojibake is what you see when text is decoded with the wrong encoding ‚Äî for example when UTF‚Äë8
          bytes are read as Latin‚Äë1 or Windows‚Äë1252. Accents and punctuation turn into strange sequences
          like <code>Fran√É¬ßois d√¢‚Ç¨‚Ñ¢Arcy √¢‚Ç¨‚Äù r√©sum√©</code>.
        </p>
        <p>
          Common culprits are copy‚Äëpasting between apps, legacy CMS setups, or files that were saved
          with one encoding but served with another.
        </p>

        <h2>What this tool fixes</h2>
        <ul>
          <li>Accented characters mangled as <code>√É¬©</code>, <code>√É¬ß</code>, <code>√É¬±</code>, and similar patterns.</li>
          <li>Curly quotes and dashes turned into <code>√¢‚Ç¨‚Ñ¢</code>, <code>√¢‚Ç¨≈ì</code>, <code>√¢‚Ç¨‚Äù</code>, <code>√¢‚Ç¨¬¶</code> and other artifacts.</li>
          <li>Optional Unicode normalization (NFC/NFKC) for more consistent search and indexing.</li>
          <li>Conservative ‚Äúsmart punctuation‚Äù for apostrophes, dashes, ellipsis, and non‚Äëbreaking spaces.</li>
        </ul>

        <h2>How to use Encoding Doctor</h2>
        <ol>
          <li>Paste the broken text into the input box or attach one or more documents.</li>
          <li>Keep ‚ÄúAuto‚Äërepair mojibake‚Äù turned on, and choose your preferred Unicode normalization.</li>
          <li>Click <strong>Fix encoding</strong>.</li>
          <li>Review the before/after comparison in the results pane.</li>
          <li>Copy the fixed text or download cleaned‚Äëup versions of your files.</li>
        </ol>

        <h2>FAQ</h2>

        <details>
          <summary>What kinds of encoding errors can this fix?</summary>
          <p>
            Encoding Doctor focuses on the most common UTF‚Äë8/Latin‚Äë1/Windows‚Äë1252 glitches:
            broken accents, curly quotes, dashes, ellipsis, and non‚Äëbreaking spaces. It is
            conservative on purpose, so it doesn‚Äôt aggressively rewrite arbitrary characters.
          </p>
        </details>

        <details>
          <summary>Will it change code snippets or markup?</summary>
          <p>
            The repair pass is tuned for human‚Äëlanguage text. It avoids heavy transformations inside
            common ASCII ranges, but if your input is mostly source code, you may want to disable
            smart punctuation and Unicode normalization.
          </p>
        </details>

        <details>
          <summary>What is Unicode normalization (NFC vs NFKC)?</summary>
          <p>
            Unicode characters can sometimes be represented in multiple equivalent ways. NFC keeps the
            visual characters the same but uses a canonical underlying form; NFKC is slightly more
            aggressive and may fold some compatibility variants together. If you are unsure, NFC is a
            safe default.
          </p>
        </details>

        <details>
          <summary>Does this change the original files on my computer?</summary>
          <p>
            No. TinyUtils processes your uploads in memory and gives you new, fixed downloads. Your
            original files are never modified and you can discard the cleaned versions if you are not
            happy with the result.
          </p>
        </details>

        <details>
          <summary>Is Encoding Doctor free to use?</summary>
          <p>
            Yes. TinyUtils tools are free to use in your browser. Light advertising helps keep the
            servers running ‚Äî but the tools work even if an ad blocker hides the slot.
          </p>
        </details>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container row between center">
      <p class="muted">&copy; <span id="footerYear"></span> TinyUtils.net</p>
      <p class="muted"><a href="/feedback.html">Feedback</a> ¬∑ <a href="/privacy.html">Privacy</a></p>
    </div>
  </footer>

  <script>
    (function initFooterYear() {
      try {
        var y = new Date().getFullYear();
        var el = document.getElementById('footerYear');
        if (el) el.textContent = String(y);
      } catch (e) {}
    })();

    function handleDataUrlDownload(event, href, filename, fallbackMime) {
      if (!href || typeof href !== 'string' || !href.startsWith('data:')) return false;
      event.preventDefault();
      try {
        var firstComma = href.indexOf(',');
        if (firstComma === -1) return false;
        var meta = href.slice(5, firstComma); // strip leading "data:"
        var dataPart = href.slice(firstComma + 1);
        var isBase64 = /;base64$/i.test(meta);
        var mimeType = (meta.replace(/;base64$/i, '') || fallbackMime || 'application/octet-stream');

        var ALLOWED_MIMES = [
          'text/plain', 'text/html', 'text/markdown', 'text/rtf', 'text/csv',
          'application/pdf', 'application/rtf',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'application/vnd.oasis.opendocument.text',
          'application/vnd.oasis.opendocument.presentation',
          'application/vnd.openxmlformats-officedocument.presentationml.presentation',
          'application/octet-stream'
        ];
        var isAllowed = ALLOWED_MIMES.some(function (allowed) { return mimeType.indexOf(allowed) === 0; });
        if (!isAllowed) {
          console.warn('encoding-doctor: unexpected MIME type in data URL:', mimeType);
          mimeType = 'application/octet-stream';
        }

        var content;
        if (isBase64) {
          var binary = atob(dataPart);
          var len = binary.length;
          var bytes = new Uint8Array(len);
          for (var i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
          content = new Blob([bytes], { type: mimeType });
        } else {
          var decoded = decodeURIComponent(dataPart.replace(/\+/g, '%20'));
          content = decoded;
        }

        if (window.tuDownloadBlob) {
          window.tuDownloadBlob({ filename: filename, mimeType: mimeType, content: content });
          return true;
        }

        var blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
          try { URL.revokeObjectURL(url); } catch (e) {}
          if (a.parentNode) a.parentNode.removeChild(a);
        }, 0);
        return true;
      } catch (e) {
        console.error('encoding-doctor: data URL download failed, falling back to default link', e);
        return false;
      }
    }

    (function initEncodingDoctor() {
      var inputText = document.getElementById('inputText');
      var fileInput = document.getElementById('fileInput');
      var optAutoRepair = document.getElementById('optAutoRepair');
      var optSmartPunctuation = document.getElementById('optSmartPunctuation');
      var optNormalizeForm = document.getElementById('optNormalizeForm');

      var runButton = document.getElementById('runButton');
      var resetButton = document.getElementById('resetButton');

      var statusText = document.getElementById('statusText');
      var errorBox = document.getElementById('errorBox');

      var resultsEmpty = document.getElementById('resultsEmpty');
      var textResults = document.getElementById('textResults');
      var outputOriginal = document.getElementById('outputOriginal');
      var outputFixed = document.getElementById('outputFixed');
      var textSummary = document.getElementById('textSummary');

      var fileResults = document.getElementById('fileResults');
      var fileResultsBody = document.getElementById('fileResultsBody');

      var isBusy = false;

      function setStatus(message) {
        if (statusText) {
          statusText.textContent = message || '';
        }
      }

      function setError(message, note) {
        if (!errorBox) return;
        if (!message) {
          errorBox.classList.add('hidden');
          errorBox.textContent = '';
          return;
        }
        var full = message;
        if (note && note !== message) {
          full += ' (' + note + ')';
        }
        errorBox.textContent = full;
        errorBox.classList.remove('hidden');
      }

      function setBusyOn() {
        isBusy = true;
        if (runButton) {
          runButton.disabled = true;
          runButton.textContent = 'Fixing‚Ä¶';
        }
      }

      function setBusyOff() {
        isBusy = false;
        if (runButton) {
          runButton.disabled = false;
          runButton.textContent = 'Fix encoding';
        }
      }

      function clearResults() {
        if (outputOriginal) outputOriginal.value = '';
        if (outputFixed) outputFixed.value = '';
        if (textSummary) textSummary.textContent = '';
        if (fileResultsBody) fileResultsBody.innerHTML = '';
        if (textResults) textResults.hidden = true;
        if (fileResults) fileResults.hidden = true;
        if (resultsEmpty) resultsEmpty.hidden = false;
      }

      function buildOptions() {
        return {
          autoRepair: !!(optAutoRepair && optAutoRepair.checked),
          smartPunctuation: !!(optSmartPunctuation && optSmartPunctuation.checked),
          normalizeForm: (optNormalizeForm && optNormalizeForm.value) || 'NFC'
        };
      }

      function readFileAsDataUrl(file) {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onerror = function () {
            reject(reader.error || new Error('file_read_error'));
          };
          reader.onload = function () {
            resolve({
              name: file.name || 'document',
              blobUrl: reader.result
            });
          };
          reader.readAsDataURL(file);
        });
      }

      async function handleRun() {
        if (isBusy) return;
        setError('');
        setStatus('');

        var textValue = (inputText && inputText.value) || '';
        var trimmed = textValue.trim();
        var filesList = Array.prototype.slice.call((fileInput && fileInput.files) || []);
        if (!trimmed && filesList.length === 0) {
          setError('Paste some text or add at least one file before running Encoding Doctor.');
          return;
        }

        setBusyOn();
        clearResults();
        setStatus('Preparing input‚Ä¶');

        var payload = {
          options: buildOptions()
        };
        if (trimmed) {
          payload.text = textValue;
        }

        if (filesList.length > 0) {
          try {
            var filesPayload = [];
            for (var i = 0; i < filesList.length; i++) {
              filesPayload.push(await readFileAsDataUrl(filesList[i]));
            }
            payload.files = filesPayload;
          } catch (e) {
            console.error('encoding-doctor: failed to read files', e);
            setError('Failed to read one of the selected files. Please try again.');
            setBusyOff();
            setStatus('');
            return;
          }
        }

        setStatus('Contacting Encoding Doctor API‚Ä¶');

        try {
          var res = await fetch('/api/encoding-doctor', {
            method: 'POST',
            headers: {
              'content-type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          var contentType = res.headers.get('content-type') || '';
          var isJson = contentType.indexOf('application/json') !== -1;

          if (!isJson) {
            setError('Unexpected response from server (not JSON).');
            setStatus('');
            setBusyOff();
            return;
          }

          var data = await res.json();

          if (!res.ok || !data || data.ok === false) {
            var meta = (data && data.meta) || {};
            setError(meta.error || 'Encoding Doctor failed to process your input.', meta.note);
            setStatus('');
            setBusyOff();
            return;
          }

          setStatus('Encoding repair complete.');

          if (data.text && (data.text.original || data.text.fixed)) {
            if (outputOriginal) outputOriginal.value = data.text.original || '';
            if (outputFixed) outputFixed.value = data.text.fixed || '';
            if (textSummary) textSummary.textContent = data.text.summary || '';
            if (textResults) textResults.hidden = false;
          }

          if (Array.isArray(data.files) && data.files.length > 0 && fileResultsBody) {
            fileResultsBody.innerHTML = '';
            data.files.forEach(function (file) {
              var tr = document.createElement('tr');

              var nameCell = document.createElement('td');
              nameCell.textContent = file.name || '(untitled)';

              var summaryCell = document.createElement('td');
              summaryCell.className = 'file-summary';
              summaryCell.textContent = file.summary || '';

              var previewCell = document.createElement('td');
              previewCell.className = 'file-preview';
              var before = file.previewOriginal || '';
              var after = file.previewFixed || '';
              previewCell.textContent = before && after
                ? before + '\n\n‚Üí\n\n' + after
                : before || after || '';

              var downloadCell = document.createElement('td');
              var downloadWrapper = document.createElement('a');
              downloadWrapper.href = file.blobUrl || '#';
              downloadWrapper.className = 'download-link';
              downloadWrapper.setAttribute('download', file.name || 'encoding-doctor-output.md');

              var btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = 'Download fixed';
              downloadWrapper.appendChild(btn);

              downloadWrapper.addEventListener('click', function (event) {
                var blobUrl = file.blobUrl;
                if (!blobUrl || !blobUrl.startsWith('data:')) {
                  return;
                }
                var mime = file.contentType || 'text/markdown';
                var filename = file.name || 'encoding-doctor-output.md';
                var handled = handleDataUrlDownload(event, blobUrl, filename, mime);
                if (!handled) {
                  window.location.href = blobUrl;
                }
              });

              downloadCell.appendChild(downloadWrapper);

              tr.appendChild(nameCell);
              tr.appendChild(summaryCell);
              tr.appendChild(previewCell);
              tr.appendChild(downloadCell);

              fileResultsBody.appendChild(tr);
            });

            if (fileResults) fileResults.hidden = false;
          }

          if (resultsEmpty) {
            var hasAny =
              (data.text && (data.text.original || data.text.fixed)) ||
              (Array.isArray(data.files) && data.files.length > 0);
            resultsEmpty.hidden = !!hasAny;
          }
        } catch (e) {
          console.error('encoding-doctor: request failed', e);
          setError('Unexpected error while talking to the server. Please try again.');
          setStatus('');
        } finally {
          setBusyOff();
        }
      }

      async function copyText(txt){
        if (!txt) return;
        try {
          await navigator.clipboard.writeText(String(txt));
          setStatus('Copied to clipboard.');
        } catch (e) {
          console.warn('encoding-doctor: copy failed', e);
          setStatus('Copy failed.');
        }
      }

      function handleReset() {
        if (inputText) inputText.value = '';
        if (fileInput) fileInput.value = '';
        if (optAutoRepair) optAutoRepair.checked = true;
        if (optSmartPunctuation) optSmartPunctuation.checked = true;
        if (optNormalizeForm) optNormalizeForm.value = 'NFC';
        setError('');
        setStatus('');
        clearResults();
      }

      if (runButton) {
        runButton.addEventListener('click', handleRun);
      }
      if (resetButton) {
        resetButton.addEventListener('click', handleReset);
      }

      if (copyOriginal && outputOriginal) {
        copyOriginal.addEventListener('click', function () {
          copyText(outputOriginal.value || '');
        });
      }
      if (copyFixed && outputFixed) {
        copyFixed.addEventListener('click', function () {
          copyText(outputFixed.value || '');
        });
      }

      document.addEventListener('keydown', function (e) {
        var tag = (e.target && e.target.tagName) || '';
        var inField = /^(INPUT|TEXTAREA|SELECT)$/.test(tag) || !!(e.target && e.target.isContentEditable);
        if (!(e.metaKey || e.ctrlKey)) return;
        if (isBusy) return;
        if (e.key === 'Enter') {
          e.preventDefault();
          if (runButton) runButton.click();
          if (outputFixed) outputFixed.focus();
        }
      });
    })();
  </script>
  </body>
</html>

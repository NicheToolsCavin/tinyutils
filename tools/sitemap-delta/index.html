<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sitemap Delta + Redirect Mapper ‚Äî TinyUtils</title>
  <meta name="description" content="Compare two sitemaps (or paste XML), see added/removed URLs, and auto-suggest 301 mappings with confidence scores. Export CSV/JSON.">
  <link rel="canonical" href="/tools/sitemap-delta/">
  <link rel="icon" href="/public/favicon.ico">
  <meta property="og:title" content="Sitemap Delta + Redirect Mapper ‚Äî TinyUtils">
  <meta property="og:description" content="Compare two sitemaps, export a 301 redirect plan, and fix migrations fast.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/public/og.png">
  <meta name="twitter:card" content="summary_large_image">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3079281180008443" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/public/styles.css">
  <link rel="stylesheet" href="/styles/site.css">
  <script defer src="/scripts/consent.js"></script>
  <script defer src="/scripts/adsense-monitor.js"></script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Sitemap Delta + Redirect Mapper",
  "applicationCategory": "SEO Tool",
  "operatingSystem": "Web",
  "url": "https://tinyutils-eight.vercel.app/tools/sitemap-delta/",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "publisher": { "@type": "Organization", "name": "TinyUtils" }
}
</script>

<style>.toast{position:fixed;right:12px;bottom:12px;background:#0b1224;color:#e6edf7;border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:10px;z-index:9999;box-shadow:0 6px 20px rgba(0,0,0,.25)}  .cell-url, td.url, .urlCell { word-break: break-all; }
</style>
</head>
<body>
<header class="site-header">
  <div class="container row between center">
    <a class="brand" href="/">TinyUtils</a>
    <nav class="nav">
      <a class="active" href="/tools/">Tools</a>
      <a href="/cookies.html">Cookie &amp; privacy settings</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/terms.html">Terms</a>
    </nav>
  </div>
</header>

<main>
  <section class="container tool-hero">
    <h1>üß≠ Sitemap Delta + Redirect Mapper</h1>
    <p class="sub">Compare two sitemaps (or paste XML), detect <b>added / removed</b> URLs, and auto-suggest <b>301</b> mappings. Export CSV/JSON.</p>
  </section>

  <section class="container card">
    <section class="grid">
      <div>
        <label class="lbl">Sitemap A (before)</label>
        <input id="smA" type="url" placeholder="https://example.com/sitemap.xml">
        <details><summary>or paste XML</summary>
          <div style="margin:6px 0"><input id="fileA" type="file" accept=".xml,.gz"></div>
          <textarea id="smAText" placeholder="&lt;urlset&gt;...&lt;/urlset&gt;"></textarea>
        </details>
      </div>
      <div>
        <label class="lbl">Sitemap B (after)</label>
        <input id="smB" type="url" placeholder="https://example.com/sitemap.xml">
        <details><summary>or paste XML</summary>
          <div style="margin:6px 0"><input id="fileB" type="file" accept=".xml,.gz"></div>
          <textarea id="smBText" placeholder="&lt;urlset&gt;...&lt;/urlset&gt;"></textarea>
        </details>
      </div>
    </section>

    <section class="grid options">
      <label><input id="verify" type="checkbox"> Verify target URLs (HEAD/GET, polite)</label>
      <label>Timeout (ms) <input id="timeout" type="number" min="1000" max="30000" value="10000"></label>
      <label>Max compare <input id="limit" type="number" min="100" max="5000" value="2000"></label>
      <button id="runBtn" class="btn">Compare</button> <button id="demoBtn" class="btn secondary">Try a demo</button> <span title="Polite by default ‚Äî sitemaps only; optional HEAD verification uses per-origin caps and timeouts." aria-label="Polite mode">‚ùì</span>
    </section>

    
    <section class="container" style="margin-top:8px">
      <label><input id="sameReg" type="checkbox" checked> Limit mappings to the same registrable domain</label>
      <div class="chips" id="confChips" style="margin-top:6px">
        <span class="chip chip-active" data-thr="0">All</span>
        <span class="chip" data-thr="0.85">‚â•85%</span>
        <span class="chip" data-thr="0.70">‚â•70%</span>
      </div>
    </section>

    <section id="status" class="status" aria-live="polite">Ready.</section>
    <section id="summary" class="summary hidden"></section>

    <section class="actions hidden" id="actions">
      <button id="dl410" class="btn secondary">Export Unmapped as 410 CSV</button>
      <button id="dlNginx" class="btn secondary">Export nginx rewrites</button>
      <button id="dlApache" class="btn secondary">Export Apache redirects</button>
      <button id="dlCsv" class="btn secondary">Export CSV</button>
      <button id="dlJson" class="btn secondary">Export JSON</button>
      <button id="copySummary" class="btn secondary">Copy summary</button>
      <button id="copyRules" class="btn secondary">Copy rewrites</button>
      <button id="share" class="btn">Share settings</button>
    </section>

    <section id="tables" class="hidden">
      <h3>Suggested 301 mappings</h3>
      <div class="tableWrap">
        <table id="mapTable">
          <thead><tr><th>From (removed)</th><th>To (best match)</th><th>Confidence</th><th>Note</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3>Unmapped (consider 410)</h3>
      <div class="tableWrap">
        <table id="unmappedTable"><thead><tr><th>URL</th></tr></thead><tbody></tbody></table>
      </div>

      <h3>Added URLs</h3>
      <div class="tableWrap">
        <table id="addedTable"><thead><tr><th>URL</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <details>
        <summary>üîß Suggested rewrite rules (nginx & Apache)</summary>
        <h4>Prefix rules</h4>
        <pre id="prefixRules" style="white-space:pre-wrap;background:#0b1224;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:8px"></pre>
        <h4>Exact mappings</h4>
        <pre id="exactRules" style="white-space:pre-wrap;background:#0b1224;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:8px"></pre>
      </details>
    </section>

    <section class="card" style="margin-top:14px">
      <details>
        <summary>üìã Migration checklist</summary>
        <ol>
          <li>Upload 301 redirects (prefix + exact) to your web server.</li>
          <li>Re-crawl key templates & high-traffic pages; confirm 2xx.</li>
          <li>Fix remaining 4xx/5xx; re-run Dead Link Finder on top nav/footer.</li>
          <li>Regenerate & submit sitemap; remove legacy sitemaps.</li>
          <li>Monitor 404/5xx and redirect chains (&lt;= 1 hop) for 48 hours.</li>
          <li>Update canonical/hreflang if structure changed.</li>
        </ol>
      </details>
    </section>

    <footer class="foot">
      <small>We fetch sitemaps and (optionally) verify target URLs. No aggressive crawling; per-origin throttling applies in verification.</small>
    </footer>
  </section>

</main>

  <script>
  const statusEl = document.getElementById('status');
  const runBtn = document.getElementById('runBtn');
  const verifyEl = document.getElementById('verify');
  const timeoutEl = document.getElementById('timeout');
  const limitEl = document.getElementById('limit');
  const smA = document.getElementById('smA');
  const smB = document.getElementById('smB');
  const smAText = document.getElementById('smAText');
  const smBText = document.getElementById('smBText');
  const sameRegEl = document.getElementById('sameReg');
  const confChips = document.getElementById('confChips');
  const summaryEl = document.getElementById('summary');
  const actionsEl = document.getElementById('actions');
  const tablesEl = document.getElementById('tables');
  const shareBtn = document.getElementById('share');
  const mapBody = document.querySelector('#mapTable tbody');
  const unmappedBody = document.querySelector('#unmappedTable tbody');
  const addedBody = document.querySelector('#addedTable tbody');
  const exportBtnIds = ['dl410','dlNginx','dlApache','dlCsv','dlJson'];
  const exportButtons = exportBtnIds.map(id => document.getElementById(id)).filter(Boolean);
  const demoBtn = document.getElementById('demoBtn');
  const LINE_BREAK = '\\r\\n';
  const DEMO_SITEMAPS = {
    before: '/tools/sitemap-delta/demo/before.xml',
    after: '/tools/sitemap-delta/demo/after.xml'
  };
  const DEMO_FALLBACK = {
    before: '<urlset><url><loc>https://example.com/blog/how-to-bake</loc></url><url><loc>https://example.com/blog/old-post</loc></url></urlset>',
    after: '<urlset><url><loc>https://example.com/articles/how-to-bake</loc></url><url><loc>https://example.com/blog/new</loc></url></urlset>'
  };

  const protectCSVCell = (value) => {
    const str = String(value ?? '');
    return /^[=+\-@]/.test(str.trimStart()) ? "'" + str : str;
  };

  const computeFiltered = (data) => {
    if (!data) return { pairs: [], unmapped: [], added: [], rules: [], meta: {} };
    const guard = sameRegEl.checked;
    const thr = confThreshold;
    const pairs = (data.pairs || []).filter(p => (p.confidence || 0) >= thr && (!guard || sameRegDomain(p.from, p.to)));
    const mapped = new Set(pairs.map(p => p.from));
    const unmapped = (data.removed || []).filter(u => !mapped.has(u));
    return {
      pairs,
      unmapped,
      added: data.added || [],
      rules: data.rules || [],
      meta: data.meta || {}
    };
  };

  let lastResults = null;
  let confThreshold = 0;

  function setExportsEnabled(enabled) {
    exportButtons.forEach(btn => {
      if (!btn) return;
      btn.disabled = !enabled;
      btn.setAttribute('aria-disabled', String(!enabled));
    });
  }
  setExportsEnabled(false);

  async function withRequestIdEcho(res) {
    try {
      const id = res.headers.get('x-request-id');
      if (!id) return;
      const host = statusEl || document.querySelector('.status');
      if (!host) return;
      const prev = host.querySelector('.requestIdEcho');
      if (prev) prev.remove();
      const small = document.createElement('span');
      small.className = 'requestIdEcho';
      small.style.marginLeft = '8px';
      small.style.opacity = '.7';
      small.style.fontSize = '12px';
      small.textContent = `(request ${id})`;
      host.appendChild(small);
    } catch {}
  }

  async function fileToText(file) {
    if (!file) return '';
    const buf = await file.arrayBuffer();
    if (file.name.endsWith('.gz') && typeof DecompressionStream !== 'undefined') {
      const ds = new DecompressionStream('gzip');
      return new Response((new Response(buf)).body.pipeThrough(ds)).text();
    }
    return new TextDecoder('utf-8').decode(new Uint8Array(buf));
  }

  const copyText = async (txt) => {
    try {
      await navigator.clipboard.writeText(txt);
      showToast('Copied');
    } catch {
      showToast('Copy failed');
    }
  };

  function showToast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.className = 'toast';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 1600);
  }

  function downloadFile(name, type, data) {
    const blob = new Blob([data], { type });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function buildHashPayload() {
    return {
      a: smA.value || undefined,
      b: smB.value || undefined,
      v: verifyEl.checked || undefined,
      t: Number(timeoutEl.value) || undefined,
      l: Number(limitEl.value) || undefined
    };
  }

  function paramsToHash() {
    return '#' + encodeURIComponent(JSON.stringify(buildHashPayload()));
  }

  function restoreFromHash(initial = false) {
    if (!location.hash) return;
    try {
      const payload = JSON.parse(decodeURIComponent(location.hash.slice(1)));
      if (typeof payload !== 'object' || payload === null) throw new Error('bad share payload');
      if ('a' in payload) smA.value = payload.a || '';
      if ('b' in payload) smB.value = payload.b || '';
      if ('v' in payload) verifyEl.checked = !!payload.v;
      if ('t' in payload && Number.isFinite(Number(payload.t))) timeoutEl.value = Number(payload.t);
      if ('l' in payload && Number.isFinite(Number(payload.l))) limitEl.value = Number(payload.l);
      if (!initial) showToast('Share settings loaded');
    } catch {
      location.hash = '';
      if (!initial) showToast('Share link invalid ‚Äî defaults restored');
    }
  }

  window.addEventListener('hashchange', () => restoreFromHash(false));

  const fileInputA = document.getElementById('fileA');
  if (fileInputA) {
    fileInputA.addEventListener('change', async () => {
      smAText.value = await fileToText(fileInputA.files[0]);
    });
  }

  const fileInputB = document.getElementById('fileB');
  if (fileInputB) {
    fileInputB.addEventListener('change', async () => {
      smBText.value = await fileToText(fileInputB.files[0]);
    });
  }

  confChips.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    confThreshold = Number(chip.dataset.thr || '0');
    confChips.querySelectorAll('.chip').forEach(c => c.classList.remove('chip-active'));
    chip.classList.add('chip-active');
    renderTables();
  });

  sameRegEl.addEventListener('change', () => {
    renderTables();
  });

  document.addEventListener('keydown', (e) => {
    const tag = (e.target && e.target.tagName) || '';
    const inField = /^(INPUT|TEXTAREA|SELECT)$/.test(tag) || !!(e.target && e.target.isContentEditable);
    if (inField) return;
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); runBtn.click(); }
    else if ((e.metaKey || e.ctrlKey) && (e.key === 'e' || e.key === 'E')) { e.preventDefault(); document.getElementById('dlCsv').click(); }
    else if ((e.metaKey || e.ctrlKey) && (e.key === 'j' || e.key === 'J')) { e.preventDefault(); document.getElementById('dlJson').click(); }
  });

  function registrable(host) {
    const parts = (host || '').toLowerCase().split('.');
    return parts.slice(-2).join('.');
  }

  function sameRegDomain(a, b) {
    try {
      const A = new URL(a).hostname;
      const B = new URL(b).hostname;
      return registrable(A) === registrable(B);
    } catch {
      return false;
    }
  }

  function renderTables() {
    if (!lastResults) return;
    const filtered = computeFiltered(lastResults);
    const meta = filtered.meta;

    summaryEl.innerHTML = `
      <div class="chips">
        <span class="chip">Removed: <b>${meta.removedCount || 0}</b></span>
        <span class="chip">Added: <b>${meta.addedCount || 0}</b></span>
        <span class="chip">Suggested 301s: <b>${filtered.pairs.length}</b></span>
        <span class="chip">Unmapped: <b>${filtered.unmapped.length}</b></span>
        <span class="chip">${meta.truncated ? 'Truncated: YES' : 'Truncated: NO'}</span>
      </div>`;
    summaryEl.classList.remove('hidden');
    actionsEl.classList.remove('hidden');
    tablesEl.classList.remove('hidden');

    mapBody.innerHTML = '';
    filtered.pairs.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="${p.from}" target="_blank" rel="noopener">${p.from}</a></td>
        <td><a href="${p.to}" target="_blank" rel="noopener">${p.to}</a></td>
        <td>${Math.round((p.confidence || 0) * 100)}%</td>
        <td>${p.note || ''}${p.verifyStatus ? ' ¬∑ head ' + p.verifyStatus : ''}</td>`;
      mapBody.appendChild(tr);
    });

    unmappedBody.innerHTML = '';
    filtered.unmapped.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="${u}" target="_blank" rel="noopener">${u}</a></td>`;
      unmappedBody.appendChild(tr);
    });

    addedBody.innerHTML = '';
    filtered.added.slice(0, 500).forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="${u}" target="_blank" rel="noopener">${u}</a></td>`;
      addedBody.appendChild(tr);
    });

    const prefixRulesEl = document.getElementById('prefixRules');
    const exactRulesEl = document.getElementById('exactRules');
    if (prefixRulesEl) {
      const lines = (filtered.rules || []).map(r => `# support ${r.support || ''}\nrewrite ^${r.fromPrefix}(.*)$ ${r.toPrefix}$1 permanent;`);
      prefixRulesEl.textContent = lines.length ? lines.join('\n') : '# (no strong prefix patterns inferred yet)';
    }
    if (exactRulesEl) {
      const lines = filtered.pairs.map(p => {
        try {
          const from = new URL(p.from);
          const to = new URL(p.to);
          return from.host === to.host
            ? `Redirect 301 ${from.pathname} ${to.pathname}`
            : `Redirect 301 ${from.pathname} ${to.href}`;
        } catch {
          return `# ${p.from} -> ${p.to}`;
        }
      });
      exactRulesEl.textContent = lines.length ? lines.join('\n') : '# (no exact mappings yet)';
    }

    const totalRows = filtered.pairs.length + filtered.unmapped.length + filtered.added.length;
    document.dispatchEvent(new CustomEvent('tinyutils:results-updated', { detail: { total: totalRows, meta } }));
    setExportsEnabled(totalRows > 0);
  }

  runBtn.addEventListener('click', async () => {
    const body = {
      sitemapAUrl: smA.value.trim() || null,
      sitemapBUrl: smB.value.trim() || null,
      sitemapAText: smAText.value.trim() || null,
      sitemapBText: smBText.value.trim() || null,
      verifyTargets: verifyEl.checked,
      timeout: Math.min(30000, Math.max(1000, Number(timeoutEl.value) || 10000)),
      maxCompare: Math.min(5000, Math.max(100, Number(limitEl.value) || 2000)),
      sameRegDomainOnly: sameRegEl.checked
    };

    if (!(body.sitemapAUrl || body.sitemapAText) || !(body.sitemapBUrl || body.sitemapBText)) {
      showToast('Provide sitemap URLs or XML for both sides.');
      statusEl.textContent = 'Waiting for input.';
      return;
    }

    statusEl.textContent = 'Working‚Ä¶';
    summaryEl.classList.add('hidden');
    actionsEl.classList.add('hidden');
    tablesEl.classList.add('hidden');
    const hadResults = !!lastResults;
    setExportsEnabled(false);

    try {
      const res = await fetch('/api/sitemap-delta', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(body)
      });
      await withRequestIdEcho(res);
      const data = await res.json();
      if (!res.ok) throw new Error(data?.meta?.note || data?.error || `HTTP ${res.status}`);
      lastResults = data;
      renderTables();
      statusEl.textContent = 'Done.';
      history.replaceState(null, '', paramsToHash());
    } catch (error) {
      console.error('[sitemap-delta]', error);
      if (hadResults && lastResults) setExportsEnabled(true);
      statusEl.textContent = 'Error: ' + (error.message || String(error));
    }
  });

  document.getElementById('dlCsv').addEventListener('click', () => {
    if (!lastResults) return;
    const filtered = computeFiltered(lastResults);
    const rows = [['from_url','to_url','confidence','note']];
    filtered.pairs.forEach(p => {
      rows.push([
        protectCSVCell(p.from || ''),
        protectCSVCell(p.to || ''),
        protectCSVCell((p.confidence || 0).toFixed(3)),
        protectCSVCell(p.note || '')
      ]);
    });
    const metaLine = '# meta: ' + JSON.stringify({
      ...lastResults.meta,
      threshold: confThreshold,
      sameDomainGuard: sameRegEl.checked
    });
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join(LINE_BREAK);
    downloadFile('sitemap-delta-redirects.csv', 'text/csv', `${csv}${LINE_BREAK}${metaLine}`);
  });

  document.getElementById('dlJson').addEventListener('click', () => {
    if (!lastResults) return;
    const payload = {
      ...lastResults,
      meta: {
        ...lastResults.meta,
        threshold: confThreshold,
        sameDomainGuard: sameRegEl.checked
      }
    };
    downloadFile('sitemap-delta-results.json', 'application/json', JSON.stringify(payload, null, 2));
  });

  document.getElementById('dl410').addEventListener('click', () => {
    if (!lastResults) return;
    const filtered = computeFiltered(lastResults);
    const rows = [['url_to_remove','reason']];
    filtered.unmapped.forEach(u => {
      rows.push([
        protectCSVCell(u),
        protectCSVCell('410')
      ]);
    });
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join(LINE_BREAK);
    downloadFile('unmapped-410.csv', 'text/csv', csv);
  });

  document.getElementById('dlNginx').addEventListener('click', () => {
    if (!lastResults) return;
    const { pairs, rules } = computeFiltered(lastResults);
    const lines = [];
    (rules || []).forEach(r => lines.push(`rewrite ^${r.fromPrefix}(.*)$ ${r.toPrefix}$1 permanent;`));
    (pairs || []).forEach(p => {
      try {
        const from = new URL(p.from);
        const to = new URL(p.to);
        if (from.host === to.host) {
          lines.push(`rewrite ^${from.pathname}$ ${to.pathname} permanent;`);
        } else {
          lines.push(`rewrite ^${from.pathname}$ ${to.href} permanent;`);
        }
      } catch {
        lines.push(`# ${p.from} -> ${p.to}`);
      }
    });
    downloadFile('redirects-nginx.conf', 'text/plain', lines.join('\n'));
  });

  document.getElementById('dlApache').addEventListener('click', () => {
    if (!lastResults) return;
    const { pairs, rules } = computeFiltered(lastResults);
    const lines = [];
    (rules || []).forEach(r => lines.push(`# Prefix: ${r.fromPrefix} -> ${r.toPrefix}`));
    (pairs || []).forEach(p => {
      try {
        const from = new URL(p.from);
        const to = new URL(p.to);
        if (from.host === to.host) {
          lines.push(`Redirect 301 ${from.pathname} ${to.pathname}`);
        } else {
          lines.push(`Redirect 301 ${from.pathname} ${to.href}`);
        }
      } catch {
        lines.push(`# ${p.from} -> ${p.to}`);
      }
    });
    downloadFile('redirects-apache.conf', 'text/plain', lines.join('\n'));
  });

  document.getElementById('copySummary').addEventListener('click', () => {
    if (!lastResults) return;
    const filtered = computeFiltered(lastResults);
    const meta = filtered.meta || {};
    const txt = [
      `Removed: ${meta.removedCount || 0}`,
      `Added: ${meta.addedCount || 0}`,
      `Suggested 301s: ${filtered.pairs.length}`,
      `Unmapped: ${filtered.unmapped.length}`
    ].join('\n');
    copyText(txt);
  });

  document.getElementById('copyRules').addEventListener('click', () => {
    const prefix = (document.getElementById('prefixRules') || {}).textContent || '';
    const exact = (document.getElementById('exactRules') || {}).textContent || '';
    copyText(`# nginx\n${prefix}\n\n# Apache\n${exact}`);
  });

  shareBtn.addEventListener('click', async () => {
    const hash = paramsToHash();
    location.hash = hash;
    await copyText(location.href);
  });

  if (demoBtn) {
    demoBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Loading demo‚Ä¶';
      try {
        const [beforeXml, afterXml] = await Promise.all([
          fetchDemoAsset(DEMO_SITEMAPS.before),
          fetchDemoAsset(DEMO_SITEMAPS.after)
        ]);
        applyDemoXml(beforeXml, afterXml);
        statusEl.textContent = 'Demo loaded ‚Äî press Compare';
      } catch (error) {
        console.warn('Demo fetch failed; falling back to inline sample', error);
        applyDemoXml(DEMO_FALLBACK.before, DEMO_FALLBACK.after);
        statusEl.textContent = 'Demo fallback loaded ‚Äî press Compare';
      }
    });
  }

  async function fetchDemoAsset(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.text();
  }

  function applyDemoXml(before, after) {
    smAText.value = (before || '').trim();
    smBText.value = (after || '').trim();
    smA.value = '';
    smB.value = '';
  }

  restoreFromHash(true);
  renderTables();
  </script>


<script>
(function(){
  const PROD = /tinyutils\.net$/.test(location.hostname);
  // minimal consent bar (bottom-right)
  const needsConsent = PROD && !localStorage.getItem('consent');
  if (needsConsent){
    const bar = document.createElement('div');
    bar.style.cssText='position:fixed;right:12px;bottom:12px;background:#0b1224;color:#e6edf7;border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:10px;z-index:9999;font:14px system-ui';
    bar.innerHTML = 'Analytics & ads help keep this free. <button id="c-yes" style="margin-left:8px">OK</button> <button id="c-no" style="margin-left:4px">No</button>';
    document.body.appendChild(bar);
    bar.querySelector('#c-yes').onclick=function(){ localStorage.setItem('consent','yes'); bar.remove(); loadProd(); };
    bar.querySelector('#c-no').onclick=function(){ localStorage.setItem('consent','no'); bar.remove(); };
  } else if (PROD && localStorage.getItem('consent')==='yes'){ loadProd(); }

  function loadProd(){
    // Plausible (privacy-first)
    var s=document.createElement('script'); s.defer=true; s.setAttribute('data-domain','tinyutils-eight.vercel.app');
    s.src='https://plausible.io/js/script.js'; document.head.appendChild(s);
    // AdSense (auto ads) ‚Äî only if explicitly allowed and non-EU in your prod config.
    if (localStorage.getItem('ads')==='on'){
      var ads=document.createElement('script');
      ads.async=true; ads.src='https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX';
      ads.crossOrigin='anonymous'; document.head.appendChild(ads);
    }
  }
})();

</script>

<footer class="site-footer">
  <div class="container row between wrap">
    <span>¬© <span id="y"></span> TinyUtils</span>
    <span><a href="/privacy.html">Privacy</a> ¬∑ <a href="/terms.html">Terms</a></span>
  </div>
</footer>
<script>document.getElementById('y').textContent = new Date().getFullYear();</script>

</body>
</html>

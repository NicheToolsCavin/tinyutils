<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dead Link Finder ‚Äî TinyUtils</title>
  <meta name="description" content="Find broken links fast. Crawl a page, paste a list, or load a sitemap. Export CSV/JSON/XLSX and grab Wayback snapshots.">
  <link rel="canonical" href="https://tinyutils.net/tools/dead-link-finder/">
  <link rel="icon" href="/public/favicon.ico">
  <meta property="og:title" content="Dead Link Finder ‚Äî TinyUtils">
  <meta property="og:description" content="Find broken links fast. Crawl a page, paste a list, or load a sitemap. Export CSV/JSON/XLSX and grab Wayback snapshots.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/public/og.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/public/styles.css">
  <link rel="stylesheet" href="/styles/site.css">
  <script defer src="/scripts/consent.js"></script>
  <style>
    main { padding-bottom: 48px; }
    .tool-intro h1 { margin-bottom: 0.25rem; }
    .tool-intro p { margin-top: 0; color: var(--muted, #97a3c2); }
    .card { margin-top: 1rem; }
    .mode-group { display: flex; gap: 1rem; flex-wrap: wrap; }
    .mode-field { margin-top: 1rem; }
    .mode-field.hidden { display: none; }
    .options-grid { display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 1rem; }
    .actions-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-top: 1rem; }
    .actions-row button.primary { background: var(--brand, #3b82f6); color: #fff; border: none; padding: 0.65rem 1.4rem; border-radius: 0.75rem; cursor: pointer; }
    .actions-row button.primary[disabled] { opacity: 0.6; cursor: not-allowed; }
    .actions-row button.secondary { background: transparent; color: inherit; border: 1px solid rgba(255,255,255,0.2); border-radius: 0.75rem; padding: 0.55rem 1.25rem; cursor: pointer; }
    .advanced details { margin-top: 1rem; }
    .advanced-grid { display: grid; gap: 0.5rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 0.75rem; }
    label span.help { color: var(--muted, #97a3c2); font-size: 0.8rem; display: block; margin-top: 0.2rem; }
    textarea { min-height: 160px; }
    #progress { min-height: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .status-bar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .filter-group { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .export-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    .export-group button { border-radius: 0.6rem; padding: 0.5rem 1rem; border: 1px solid rgba(255,255,255,0.18); background: transparent; color: inherit; cursor: pointer; }
    .export-group button:disabled { opacity: 0.4; cursor: not-allowed; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #0b1224; color: #e6edf7; border: 1px solid rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 10px; z-index: 9999; box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
    .tableWrap { margin-top: 1rem; }
    td .url-text { word-break: break-all; display: inline-block; max-width: 420px; }
    .cell-url { word-break: break-all; }
    .visually-hidden { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container row between center">
      <a class="brand" href="/">TinyUtils</a>
      <nav class="nav">
        <a class="active" href="/tools/">Tools</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container tool-intro">
      <h1>üîç Dead Link Finder</h1>
      <p>Paste URLs, crawl a page, or load a sitemap. Check response codes, respect robots, and export results with Wayback helpers.</p>
      <p><a class="cta" href="/tools/">See all tools ‚Üí</a></p>

      <section class="card" role="region" aria-labelledby="inputHeading">
        <h2 id="inputHeading">Input</h2>
        <fieldset class="mode-group" aria-label="Mode">
          <legend>Mode</legend>
          <label for="modePage"><input type="radio" name="mode" id="modePage" value="crawl" checked> Page</label>
          <label for="modeList"><input type="radio" name="mode" id="modeList" value="list"> List</label>
          <label for="modeSitemap"><input type="radio" name="mode" id="modeSitemap" value="sitemap"> Sitemap</label>
        </fieldset>

        <div class="mode-field" data-mode="crawl">
          <label for="pageUrl">Page URL</label>
          <input id="pageUrl" type="url" placeholder="https://example.com/page">
        </div>
        <div class="mode-field hidden" data-mode="list">
          <label for="listInput">URLs (one per line)</label>
          <textarea id="listInput" placeholder="https://example.com/one\nhttps://example.com/two"></textarea>
        </div>
        <div class="mode-field hidden" data-mode="sitemap">
          <label for="sitemapUrl">Sitemap URL</label>
          <input id="sitemapUrl" type="url" placeholder="https://example.com/sitemap.xml">
        </div>

        <div class="options-grid" aria-label="Options">
          <label for="scope">Scope
            <select id="scope">
              <option value="internal" selected>Internal only</option>
              <option value="all">All links on page</option>
            </select>
          </label>
          <label for="includeAssets"><input type="checkbox" id="includeAssets"> Include assets (img/script/link)</label>
          <label for="respectRobots"><input type="checkbox" id="respectRobots" checked> Respect robots.txt</label>
          <label for="timeout">Timeout (ms)
            <input type="number" id="timeout" min="1000" max="30000" value="10000">
          </label>
          <label for="concurrency">Concurrency
            <input type="number" id="concurrency" min="1" max="10" value="10">
          </label>
        </div>

        <div class="advanced">
          <details>
            <summary>Advanced options</summary>
            <div class="advanced-grid">
              <label for="headFirst"><input type="checkbox" id="headFirst" checked> Try HEAD before GET</label>
              <label for="retryHttp"><input type="checkbox" id="retryHttp"> Retry with HTTP if HTTPS fails</label>
              <label for="includeArchive"><input type="checkbox" id="includeArchive"> Include Wayback helper</label>
            </div>
          </details>
        </div>

        <div class="actions-row">
          <button id="runBtn" class="primary" type="button">Run check</button>
          <button id="clearBtn" class="secondary" type="button">Clear</button>
          <span class="badge">Shortcuts: <kbd>Ctrl/Cmd + Enter</kbd> run ¬∑ <kbd>E</kbd> export CSV ¬∑ <kbd>C</kbd> copy CSV</span>
        </div>
        <div id="progress" aria-live="polite"></div>
      </section>

      <section class="card" role="region" aria-labelledby="resultsHeading">
        <div class="status-bar">
          <h2 id="resultsHeading" style="margin:0">Results</h2>
          <div class="filter-group">
            <label><input type="checkbox" class="statusFilter" data-group="2" checked> 2xx</label>
            <label><input type="checkbox" class="statusFilter" data-group="3" checked> 3xx</label>
            <label><input type="checkbox" class="statusFilter" data-group="4" checked> 4xx</label>
            <label><input type="checkbox" class="statusFilter" data-group="5" checked> 5xx</label>
            <label><input type="checkbox" class="statusFilter" data-group="null" checked> Unknown</label>
            <label for="onlyBroken"><input type="checkbox" id="onlyBroken"> Show only broken</label>
            <label for="search" class="visually-hidden">Filter results</label>
            <input id="search" type="search" placeholder="Filter results‚Ä¶" aria-label="Filter results">
          </div>
          <div class="export-group">
            <button id="exportCsv" disabled>Export CSV</button>
            <button id="copyCsv" class="ghost" disabled>Copy CSV</button>
            <button id="exportJson" class="secondary" disabled>Export JSON</button>
            <button id="exportXls" class="secondary" disabled>Export Excel</button>
            <button id="shareBtn" class="ghost" disabled>Share</button>
            <span id="summary"></span>
          </div>
        </div>
        <div class="tableWrap">
          <table id="results">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">URL</th>
                <th scope="col">Status</th>
                <th scope="col">OK?</th>
                <th scope="col">Final URL</th>
                <th scope="col">Wayback</th>
                <th scope="col">Replace</th>
                <th scope="col">Note</th>
                <th scope="col">Chain</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container row between wrap">
      <span>¬© <span id="year"></span> TinyUtils</span>
      <span><a href="/privacy.html">Privacy</a> ¬∑ <a href="/terms.html">Terms</a></span>
    </div>
  </footer>

  <script>
    function clampInt(value, min, max, fallback) {
      const num = Number.parseInt(value, 10);
      if (Number.isNaN(num)) return fallback;
      return Math.min(max, Math.max(min, num));
    }

    function protectCSVCell(value) {
      const str = String(value ?? '');
      return /^[=+\-@]/.test(str) ? "'" + str : str;
    }

    function escapeHtml(value) {
      return String(value ?? '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch]);
    }

    function statusGroup(status) {
      if (status == null) return 'null';
      const n = Number(status);
      if (n >= 200 && n < 300) return '2';
      if (n >= 300 && n < 400) return '3';
      if (n >= 400 && n < 500) return '4';
      if (n >= 500 && n < 600) return '5';
      return 'null';
    }

    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const div = document.createElement('div');
      div.className = 'toast';
      div.textContent = message;
      document.body.appendChild(div);
      setTimeout(() => { div.remove(); }, 4000);
    }

    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const modeFields = document.querySelectorAll('.mode-field');
    const pageUrlEl = document.getElementById('pageUrl');
    const listInputEl = document.getElementById('listInput');
    const sitemapUrlEl = document.getElementById('sitemapUrl');
    const scopeEl = document.getElementById('scope');
    const includeAssetsEl = document.getElementById('includeAssets');
    const respectRobotsEl = document.getElementById('respectRobots');
    const timeoutEl = document.getElementById('timeout');
    const concurrencyEl = document.getElementById('concurrency');
    const headFirstEl = document.getElementById('headFirst');
    const retryHttpEl = document.getElementById('retryHttp');
    const includeArchiveEl = document.getElementById('includeArchive');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const progressEl = document.getElementById('progress');
    const summaryEl = document.getElementById('summary');
    const resultsBody = document.querySelector('#results tbody');
    const exportCsvBtn = document.getElementById('exportCsv');
    const copyCsvBtn = document.getElementById('copyCsv');
    const exportJsonBtn = document.getElementById('exportJson');
    const exportXlsBtn = document.getElementById('exportXls');
    const shareBtn = document.getElementById('shareBtn');
    const searchEl = document.getElementById('search');
    const onlyBrokenEl = document.getElementById('onlyBroken');
    const statusFilters = document.querySelectorAll('.statusFilter');

    document.getElementById('year').textContent = new Date().getFullYear();

    function getSelectedMode() {
      const checked = document.querySelector('input[name="mode"]:checked');
      return checked ? checked.value : 'crawl';
    }

    function updateModeVisibility() {
      const current = getSelectedMode();
      modeFields.forEach((field) => {
        field.classList.toggle('hidden', field.getAttribute('data-mode') !== current);
      });
    }

    modeRadios.forEach((radio) => {
      radio.addEventListener('change', updateModeVisibility);
    });
    updateModeVisibility();

    function setExportState(enabled) {
      [exportCsvBtn, copyCsvBtn, exportJsonBtn, exportXlsBtn].forEach((btn) => {
        btn.disabled = !enabled;
      });
    }

    let lastResults = [];
    let meta = null;

    function renderRows(rows) {
      resultsBody.innerHTML = '';
      rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.dataset.group = statusGroup(row.status);
        tr.dataset.ok = row.ok ? '1' : '0';
        const archiveUrl = row.archive && row.archive.url ? row.archive.url : '';
        const archiveCell = archiveUrl ? `<a href="${escapeHtml(archiveUrl)}" target="_blank" rel="noopener">snapshot</a>` : '';
        const replaceCell = archiveUrl ? `<button type="button" class="ghost" data-copy="${escapeHtml(archiveUrl)}">Copy Wayback</button>` : '';
        const finalLink = row.finalUrl ? `<a href="${escapeHtml(row.finalUrl)}" target="_blank" rel="noopener">${escapeHtml(row.finalUrl)}</a>` : '';
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td class="cell-url"><a href="${escapeHtml(row.url)}" target="_blank" rel="noopener" class="url-text">${escapeHtml(row.url)}</a></td>
          <td>${row.status ?? ''}</td>
          <td>${row.ok ? '‚úÖ' : '‚ùå'}</td>
          <td class="cell-url">${finalLink}</td>
          <td>${archiveCell}</td>
          <td>${replaceCell}</td>
          <td class="cell-url">${escapeHtml(row.note || '')}</td>
          <td>${row.chain ?? 0}</td>
        `;
        resultsBody.appendChild(tr);
      });

      resultsBody.querySelectorAll('button[data-copy]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(btn.getAttribute('data-copy'));
            btn.textContent = 'Copied';
            setTimeout(() => { btn.textContent = 'Copy Wayback'; }, 1200);
          } catch (err) {
            showToast('Copy failed: ' + err.message);
          }
        });
      });

      applyFilters();
    }

    function applyFilters() {
      const activeGroups = Array.from(statusFilters).filter((cb) => cb.checked).map((cb) => cb.getAttribute('data-group'));
      const searchTerm = searchEl.value.trim().toLowerCase();
      const onlyBroken = !!(onlyBrokenEl && onlyBrokenEl.checked);

      Array.from(resultsBody.querySelectorAll('tr')).forEach((tr) => {
        const matchesStatus = activeGroups.includes(tr.dataset.group);
        const matchesSearch = searchTerm ? tr.textContent.toLowerCase().includes(searchTerm) : true;
        const matchesBroken = onlyBroken ? tr.dataset.ok !== '1' : true;
        const visible = matchesStatus && matchesSearch && matchesBroken;
        tr.style.display = visible ? '' : 'none';
      });
    }

    statusFilters.forEach((cb) => cb.addEventListener('change', applyFilters));
    if (onlyBrokenEl) onlyBrokenEl.addEventListener('change', applyFilters);
    searchEl.addEventListener('input', applyFilters);

    function toCSV(rows, metaInfo) {
      const header = ['url', 'status', 'ok', 'finalUrl', 'archiveUrl', 'note', 'chain'];
      const escapeCell = (value) => `"${protectCSVCell(String(value ?? '')).replace(/"/g, '""')}"`;
      const lines = [header.join(',')];
      rows.forEach((row) => {
        lines.push([
          row.url,
          row.status ?? '',
          row.ok ? 'true' : 'false',
          row.finalUrl ?? '',
          row.archive && row.archive.url ? row.archive.url : '',
          row.note ?? '',
          row.chain ?? 0
        ].map(escapeCell).join(','));
      });
      if (metaInfo) {
        lines.push('# meta: ' + JSON.stringify(metaInfo));
      }
      return lines.join('\n');
    }

    function toJSONPayload(rows, metaInfo) {
      return JSON.stringify({ meta: metaInfo, results: rows }, null, 2);
    }

    function toExcelXML(rows) {
      const header = ['URL', 'Status', 'OK', 'Final URL', 'Archive URL', 'Note', 'Chain'];
      const escapeCell = (value) => escapeHtml(String(value ?? ''));
      const tableRows = rows.map((row) => `
        <tr>
          <td>${escapeCell(row.url)}</td>
          <td>${escapeCell(row.status ?? '')}</td>
          <td>${row.ok ? 'true' : 'false'}</td>
          <td>${escapeCell(row.finalUrl ?? '')}</td>
          <td>${escapeCell(row.archive && row.archive.url ? row.archive.url : '')}</td>
          <td>${escapeCell(row.note ?? '')}</td>
          <td>${escapeCell(row.chain ?? 0)}</td>
        </tr>`).join('');
      return `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><table><thead><tr>${header.map((h) => `<th>${escapeCell(h)}</th>`).join('')}</tr></thead><tbody>${tableRows}</tbody></table></body></html>`;
    }

    function download(name, text, type = 'text/plain') {
      const blob = new Blob([text], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    exportCsvBtn.addEventListener('click', () => {
      if (!lastResults.length) return;
      download('dead-links.csv', toCSV(lastResults, meta), 'text/csv');
    });

    copyCsvBtn.addEventListener('click', async () => {
      if (!lastResults.length) return;
      try {
        await navigator.clipboard.writeText(toCSV(lastResults, meta));
        copyCsvBtn.textContent = 'Copied';
        setTimeout(() => { copyCsvBtn.textContent = 'Copy CSV'; }, 1200);
      } catch (err) {
        showToast('Copy failed: ' + err.message);
      }
    });

    exportJsonBtn.addEventListener('click', () => {
      if (!lastResults.length) return;
      download('dead-links.json', toJSONPayload(lastResults, meta), 'application/json');
    });

    exportXlsBtn.addEventListener('click', () => {
      if (!lastResults.length) return;
      download('dead-links.xls', toExcelXML(lastResults), 'application/vnd.ms-excel');
    });

    function encodeState() {
      const state = {
        mode: getSelectedMode(),
        pageUrl: pageUrlEl.value.trim(),
        list: listInputEl.value,
        sitemapUrl: sitemapUrlEl.value.trim(),
        scope: scopeEl.value,
        includeAssets: includeAssetsEl.checked,
        respectRobots: respectRobotsEl.checked,
        headFirst: headFirstEl.checked,
        retryHttp: retryHttpEl.checked,
        includeArchive: includeArchiveEl.checked,
        timeout: clampInt(timeoutEl.value, 1000, 30000, 10000),
        concurrency: clampInt(concurrencyEl.value, 1, 10, 10)
      };
      const json = JSON.stringify(state);
      const bytes = new TextEncoder().encode(json);
      let binary = '';
      bytes.forEach((b) => { binary += String.fromCharCode(b); });
      return btoa(binary);
    }

    function decodeState(hash) {
      try {
        const binary = atob(hash);
        const bytes = Uint8Array.from(binary, (ch) => ch.charCodeAt(0));
        const json = new TextDecoder().decode(bytes);
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function applyState(state) {
      const mode = state.mode || 'crawl';
      const radio = document.querySelector(`input[name="mode"][value="${mode}"]`);
      if (radio) radio.checked = true;
      pageUrlEl.value = state.pageUrl || '';
      listInputEl.value = state.list || '';
      sitemapUrlEl.value = state.sitemapUrl || '';
      scopeEl.value = state.scope === 'all' ? 'all' : 'internal';
      includeAssetsEl.checked = !!state.includeAssets;
      respectRobotsEl.checked = state.respectRobots !== false;
      headFirstEl.checked = state.headFirst !== false;
      retryHttpEl.checked = !!state.retryHttp;
      includeArchiveEl.checked = !!state.includeArchive;
      timeoutEl.value = clampInt(state.timeout, 1000, 30000, 10000);
      concurrencyEl.value = clampInt(state.concurrency, 1, 10, 10);
      updateModeVisibility();
    }

    const defaultState = {
      mode: 'crawl',
      pageUrl: '',
      list: '',
      sitemapUrl: '',
      scope: 'internal',
      includeAssets: false,
      respectRobots: true,
      headFirst: true,
      retryHttp: false,
      includeArchive: false,
      timeout: 10000,
      concurrency: 10
    };

    function resetState() {
      applyState(defaultState);
    }

    shareBtn.disabled = false;

    shareBtn.addEventListener('click', async () => {
      const encoded = encodeState();
      const url = `${location.origin}${location.pathname}#${encoded}`;
      try {
        await navigator.clipboard.writeText(url);
        showToast('Sharable link copied to clipboard');
      } catch {
        prompt('Copy this link', url);
      }
    });

    function ensureMeta(payload, data, mode) {
      const base = data && data.meta ? { ...data.meta } : {};
      base.runTimestamp = base.runTimestamp || new Date().toISOString();
      base.mode = mode;
      base.source = payload.pageUrl || payload.sitemapUrl || 'list';
      base.concurrency = clampInt(concurrencyEl.value, 1, 10, 10);
      base.timeoutMs = clampInt(timeoutEl.value, 1000, 30000, 10000);
      base.robots = payload.respectRobots;
      base.scope = payload.scope;
      base.assets = payload.includeAssets;
      base.httpFallback = payload.retryHttp;
      base.wayback = payload.includeArchive;
      base.totalQueued = base.totalQueued ?? data?.totalQueued ?? lastResults.length;
      base.totalChecked = base.totalChecked ?? lastResults.length;
      base.truncated = base.truncated ?? !!data?.truncated;
      return base;
    }

    runBtn.addEventListener('click', async () => {
      const mode = getSelectedMode();
      const timeoutMs = clampInt(timeoutEl.value, 1000, 30000, 10000);
      const concurrency = clampInt(concurrencyEl.value, 1, 10, 10);

      const payload = {
        mode,
        scope: scopeEl.value,
        includeAssets: includeAssetsEl.checked,
        respectRobots: respectRobotsEl.checked,
        headFirst: headFirstEl.checked,
        retryHttp: retryHttpEl.checked,
        includeArchive: includeArchiveEl.checked,
        timeout: timeoutMs,
        concurrency
      };

      if (mode === 'crawl') {
        payload.pageUrl = pageUrlEl.value.trim();
        if (!payload.pageUrl) {
          progressEl.textContent = 'Please enter a page URL to crawl.';
          pageUrlEl.focus();
          return;
        }
      } else if (mode === 'list') {
        const raw = listInputEl.value.trim();
        if (!raw) {
          progressEl.textContent = 'Please enter at least one URL.';
          listInputEl.focus();
          return;
        }
        const lines = raw.split(/\r?\n/).map((line) => line.trim()).filter(Boolean);
        if (!lines.length) {
          progressEl.textContent = 'Please enter at least one valid URL.';
          listInputEl.focus();
          return;
        }
        if (lines.length > 1000) {
          showToast('Only the first 1000 URLs will be checked to stay polite.');
        }
        payload.list = lines.slice(0, 1000).join('\n');
      } else if (mode === 'sitemap') {
        payload.sitemapUrl = sitemapUrlEl.value.trim();
        if (!payload.sitemapUrl) {
          progressEl.textContent = 'Please enter a sitemap URL.';
          sitemapUrlEl.focus();
          return;
        }
      }

      progressEl.textContent = 'Running‚Ä¶';
      runBtn.disabled = true;
      setExportState(false);
      resultsBody.innerHTML = '';
      summaryEl.textContent = '';

      try {
        const response = await fetch('/api/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data && data.message ? data.message : `Request failed (${response.status})`);
        }
        lastResults = Array.isArray(data.results) ? data.results : [];
        meta = ensureMeta(payload, data, mode);
        renderRows(lastResults);
        const broken = lastResults.filter((row) => !row.ok).length;
        const truncatedLabel = meta.truncated ? ' (soft cap reached)' : '';
        summaryEl.textContent = `${lastResults.length} checked ¬∑ ${broken} broken${truncatedLabel}`;
        setExportState(lastResults.length > 0);
        progressEl.textContent = 'Done';
      } catch (error) {
        progressEl.textContent = 'Error: ' + error.message;
        lastResults = [];
        meta = null;
      } finally {
        runBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      listInputEl.value = '';
      pageUrlEl.value = '';
      sitemapUrlEl.value = '';
      resultsBody.innerHTML = '';
      summaryEl.textContent = '';
      progressEl.textContent = '';
      lastResults = [];
      meta = null;
      setExportState(false);
    });

    document.addEventListener('keydown', (event) => {
      if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
        event.preventDefault();
        runBtn.click();
      } else if (event.key.toLowerCase() === 'e') {
        if (!exportCsvBtn.disabled) {
          event.preventDefault();
          exportCsvBtn.click();
        }
      } else if (event.key.toLowerCase() === 'c') {
        if (!copyCsvBtn.disabled) {
          event.preventDefault();
          copyCsvBtn.click();
        }
      }
    });

    // Share state restoration
    if (location.hash.length > 1) {
      const parsed = decodeState(location.hash.slice(1));
      if (parsed) {
        applyState(parsed);
      } else {
        resetState();
        showToast('Invalid share link. Defaults restored.');
      }
    } else {
      resetState();
    }
  </script>
</body>
</html>

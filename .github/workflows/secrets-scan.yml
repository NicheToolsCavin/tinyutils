name: Secrets Scan

on:
  pull_request:
  push:
    branches: [ main, develop, ci/**, feat/**, fix/** ]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Ensure no env files are tracked
        run: |
          set -e
          if git ls-files | rg -n '(^|/)\\.env(\\..*)?$'; then
            echo 'Error: .env files must not be tracked. Remove them from git and use *.example.'
            exit 1
          fi

      - name: Heuristic secrets regex scan
        run: |
          set -e
          rg -nEI "(SECRET|TOKEN|PASSWORD|PRIVATE KEY|BEGIN RSA|aws_access_key_id|secret_access_key)" \
            --hidden \
            --glob '!**/node_modules/**' \
            --glob '!**/.git/**' \
            --glob '!tinyutils/artifacts/**' \
            --glob '!**/*.example' || true
          # Fail only if obvious private key or aws creds are present
          if rg -nEI "(BEGIN RSA|aws_access_key_id|secret_access_key)" \
            --hidden --glob '!**/node_modules/**' --glob '!**/.git/**' --glob '!tinyutils/artifacts/**'; then
            echo 'Error: High-risk secrets detected. Remove/rotate before merging.'
            exit 1
          fi

      - name: Summary
        run: echo 'Secrets scan completed.'

